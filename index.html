<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regenboog Dash: De Kristalzoektocht</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Donkere achtergrondkleur */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
            box-sizing: border-box;
        }

        #game-container {
            background-color: #2a2a4a;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5), 0 0 50px rgba(128, 0, 128, 0.5);
            padding: 30px;
            max-width: 800px;
            width: 95%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto; /* Scrollen mogelijk maken voor lange teksten */
            max-height: 95vh; /* Beperk de hoogte voor scrollen */
        }

        h1 {
            font-size: 2.8em;
            color: #ff69b4;
            text-shadow: 0 0 10px #ff69b4;
            margin-bottom: 20px;
        }

        #story-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #c0c0d0;
            min-height: 150px; /* Zorgt voor consistente hoogte */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        .choice-button {
            background-color: #8a2be2;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 10px rgba(138, 43, 226, 0.3);
            text-align: center;
            text-decoration: none; /* Voor a-tag styling */
        }

        .choice-button:hover {
            background-color: #9932cc;
            transform: translateY(-2px);
            box-shadow: 0 7px 12px rgba(138, 43, 226, 0.5);
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(138, 43, 226, 0.2);
        }

        #stats {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap; /* Zorgt ervoor dat stats op nieuwe regel komen op kleine schermen */
            font-size: 1.1em;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
            margin-top: 20px;
        }
        #stats div {
            margin: 5px 10px; /* Ruimte tussen stats */
        }


        #start-screen, #end-screen, #high-score-screen, #character-selection-rpg-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
            text-align: center;
            z-index: 200;
            padding: 20px;
            box-sizing: border-box;
        }

        #start-screen input {
            padding: 10px;
            font-size: 1.2em;
            border-radius: 5px;
            border: 1px solid #00ffff;
            background-color: #3a3a5a;
            color: #e0e0e0;
            margin-bottom: 20px;
            text-align: center;
            max-width: 300px;
            width: 80%;
        }

        #start-screen #start-game-button { /* Prominenter maken */
            font-size: 1.5em;
            padding: 20px 40px;
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.6);
            margin-top: 40px;
        }
        #start-screen #start-game-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(138, 43, 226, 0.8);
        }

        /* Nieuwe stijl voor de 'Speel als dit Personage!' knop */
        #character-selection-rpg-screen #select-character-rpg-button {
            font-size: 1.5em;
            padding: 20px 40px;
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.6);
            margin-top: 40px;
        }
        #character-selection-rpg-screen #select-character-rpg-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(138, 43, 226, 0.8);
        }


        .hidden {
            display: none !important;
        }

        .error-message {
            color: #ff69b4;
            font-size: 0.9em;
            margin-top: -15px;
            margin-bottom: 10px;
        }

        .high-score-list {
            list-style: none;
            padding: 0;
            font-size: 1.4em;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            width: 80%;
            max-width: 500px; /* Iets breder voor tijd */
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
        }

        .high-score-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .high-score-list li:last-child {
            border-bottom: none;
        }
        .high-score-list .score-details {
            display: flex;
            gap: 15px;
        }

        .character-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            max-height: 60vh; /* Scrollable if too many characters */
            overflow-y: auto;
            padding: 10px;
        }

        .character-card {
            background-color: #3a3a5a;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            width: 120px; /* Fixed width for cards */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            border-color: #00ffff;
        }

        .character-card.selected {
            border-color: #ff69b4;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.9);
            transform: scale(1.05);
        }

        .character-card h3 {
            margin: 10px 0 0;
            color: #e0e0e0;
            font-size: 1.1em;
        }
        .character-card p {
            font-size: 0.8em;
            margin: 5px 0 0;
            color: #b0b0c0;
        }

        /* Responsive aanpassingen */
        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            #story-text {
                font-size: 1em;
            }
            .choice-button {
                font-size: 1em;
                padding: 12px 20px;
            }
            #stats {
                flex-direction: column;
                gap: 10px;
            }
            #start-screen #start-game-button {
                font-size: 1.2em;
                padding: 15px 30px;
            }
            .high-score-list {
                font-size: 1.1em;
            }
            .high-score-list .score-details {
                flex-direction: column;
                gap: 5px;
                align-items: flex-end;
            }
            .character-card {
                width: 100px; /* Smaller cards on small screens */
                padding: 10px;
            }
            .character-card h3 {
                font-size: 1em;
            }
            #character-selection-rpg-screen #select-character-rpg-button {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Regenboog Dash: De Kristalzoektocht</h1>
        <div id="story-text"></div>
        <div id="choices"></div>
        <div id="stats">
            <div>Naam: <span id="player-name"></span></div>
            <div>Gezondheid: <span id="player-health">100</span></div>
            <div>Goud: <span id="player-gold">0</span></div>
            <div>Kristalscherven: <span id="player-shards">0</span>/3</div>
            <div>Reputatie: <span id="player-reputation">0</span></div>
        </div>
    </div>

    <!-- Start Scherm -->
    <div id="start-screen">
        <h2>Welkom, Regenboogwachter!</h2>
        <p>In een wereld doordrenkt van magie en mysterie, staat het legendarische Regenboogkristal centraal. Het is de bron van balans en kleur, bewaakt door jullie, de **Regenboogwachters** – een hechte groep helden, beter bekend als **Rainbow Dash**!</p>
        <p>Maar duistere tijden zijn aangebroken. Het kristal is versplinterd in drie machtige scherven, verspreid over de meest gevaarlijke uithoeken van het land. Zonder het kristal dreigt de wereld haar kleuren te verliezen en te verzinken in chaos.</p>
        <p>Jouw missie, jonge wachter, is om samen met je vrienden de scherven te vinden en het kristal te herstellen. Elke keuze telt, elke vriend kan van pas komen. Je gezondheid, goud en reputatie zullen je gids zijn. En wie weet, misschien ontdek je wel verborgen krachten...</p>
        <button id="start-game-button">Begin Avontuur</button>
        <button id="show-highscores-button">High Scores</button>
    </div>

    <!-- Character Selection Screen -->
    <div id="character-selection-rpg-screen" class="hidden">
        <h2>Kies je Personage</h2>
        <div class="character-options" id="character-options-rpg">
            <!-- Character cards will be dynamically inserted here -->
        </div>
        <button id="select-character-rpg-button" disabled>Speel als dit Personage!</button>
    </div>


    <!-- Einde Scherm -->
    <div id="end-screen" class="hidden">
        <h2>Einde van het Avontuur</h2>
        <p id="end-message"></p>
        <button id="restart-game-button">Opnieuw Spelen</button>
    </div>

    <!-- High Score Screen -->
    <div id="high-score-screen" class="hidden">
        <h2>High Scores</h2>
        <ul id="high-score-list" class="high-score-list">
            <!-- Scores will be loaded here -->
        </ul>
        <button id="back-to-menu-from-highscores-button">Terug naar Menu</button>
    </div>

    <script type="module">
        // Firebase configuratie en initialisatie (verplicht, zelfs als niet gebruikt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth, userId;
        let isFirebaseReady = false; // Track Firebase readiness
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase geïnitialiseerd. Gebruikers-ID:", userId);
                isFirebaseReady = true;
            } catch (error) {
                console.error("Fout bij initialiseren van Firebase of inloggen:", error);
            }
        }
        initFirebase();

        const storyTextElement = document.getElementById('story-text');
        const choicesElement = document.getElementById('choices');
        const playerNameDisplay = document.getElementById('player-name');
        const playerHealthDisplay = document.getElementById('player-health');
        const playerGoldDisplay = document.getElementById('player-gold');
        const playerShardsDisplay = document.getElementById('player-shards');
        const playerReputationDisplay = document.getElementById('player-reputation');
        const startScreen = document.getElementById('start-screen');
        const startGameButton = document.getElementById('start-game-button');
        const showHighscoresButton = document.getElementById('show-highscores-button');
        const endScreen = document.getElementById('end-screen');
        const endMessageElement = document.getElementById('end-message');
        const restartGameButton = document.getElementById('restart-game-button');
        const highScoreScreen = document.getElementById('high-score-screen');
        const highScoreList = document.getElementById('high-score-list');
        const backToMenuFromHighscoresButton = document.getElementById('back-to-menu-from-highscores-button');

        const characterSelectionRpgScreen = document.getElementById('character-selection-rpg-screen');
        const characterOptionsRpg = document.getElementById('character-options-rpg');
        const selectCharacterRpgButton = document.getElementById('select-character-rpg-button');


        let player = {
            name: "Avonturier",
            health: 100,
            gold: 0,
            crystalShards: 0,
            reputation: 0,
            inventory: [],
            friendsMet: [],
            chosenNpcRole: null, // Slaat de naam van de NPC op als de speler die rol op zich neemt
            startTime: 0,
            endTime: 0,
            duration: 0
        };

        // Lijst van NPC namen en hun beschrijvingen voor de selectie
        const npcCharacters = [
            { name: "Esmee", description: "De wijze strateeg, scherpzinnig en kalm." },
            { name: "Jason", description: "De onverschrokken krijger, sterk en moedig." },
            { name: "Robin", description: "De behendige sluipschutter, snel en stil." },
            { name: "Kees", description: "De altijd optimistische, brengt licht en moed." },
            { name: "Geoffrey", description: "De geleerde, vol kennis en wijsheid." },
            { name: "Pleun", description: "De vrolijke uitvinder, creatief en energiek." },
            { name: "Lisa", description: "De charmante diplomaat, overtuigend en vriendelijk." },
            { name: "Renske", description: "De empathische genezer, zorgzaam en helend." },
            { name: "Lars", description: "De tactische leider, georganiseerd en efficiënt." },
            { name: "Anouk", description: "De nuchtere overlever, veerkrachtig en praktisch." },
            { name: "Eleane", description: "De mysterieuze magiër, vol geheimen en spreuken." },
            { name: "Elizabeth", description: "De kalme wachter, geduldig en observerend." },
            { name: "Merijn", description: "De inventieve techneut, handig en vindingrijk." },
            { name: "Nadine", description: "De inspirerende bard, brengt hoop en moed." }
        ];

        let selectedCharacterName = null; // Houdt de geselecteerde character naam bij

        // Functie om de karakterkaarten te renderen
        function renderCharacterCards() {
            characterOptionsRpg.innerHTML = '';
            npcCharacters.forEach(char => {
                const card = document.createElement('div');
                card.classList.add('character-card');
                card.dataset.characterName = char.name;
                card.innerHTML = `<h3>${char.name}</h3><p>${char.description}</p>`;
                card.addEventListener('click', () => {
                    // Verwijder 'selected' van alle kaarten
                    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                    // Voeg 'selected' toe aan de geklikte kaart
                    card.classList.add('selected');
                    selectedCharacterName = char.name;
                    selectCharacterRpgButton.disabled = false;
                });
                characterOptionsRpg.appendChild(card);
            });
        }


        // Helper functie om de verhaaltekst aan te passen op basis van de gekozen NPC-rol
        function getAdjustedStoryText(originalText, stateKey) {
            let text = originalText;
            const chosenRole = player.chosenNpcRole;

            if (chosenRole) {
                // Algemene vervangingen
                // Vervang de naam van de gekozen NPC door "jij" of "jouw" waar passend
                // Dit is een complexe taak die veel specifieke regels vereist.
                // Voor een robuuste oplossing zouden we een parser nodig hebben.
                // Hieronder een poging voor de meest voorkomende gevallen.

                // Eerst de specifieke zinnen die een hele herschrijving behoeven
                if (chosenRole === "Robin") {
                    if (stateKey === "woud_observatie") {
                        text = `Je blijft stil en observeert. Jij, met je groene cape, springt behendig langs de wezens. Je knikt jezelf toe. 'Sluipen is de sleutel hier, ${player.name}.' Je reputatie stijgt.`;
                    } else if (stateKey === "dieper_woud_met_robin") {
                        text = `Jij leidt de weg door een verborgen pad langs de kloof. 'Deze weg is veiliger,' zeg je. Ik heb gehoord dat Kees en Geoffrey in de buurt zijn, op zoek naar aanwijzingen.'`;
                    } else if (stateKey === "ontmoet_kees_geoffrey") {
                        text = `Jij leidt je weg naar een open plek waar Kees, de altijd optimistische, en Geoffrey, de geleerde, bij een kampvuur zitten. 'Ah, ${player.name}!' roept Kees. 'We hebben een kaart gevonden die naar een verborgen tempel leidt waar een scherf zou zijn!' Geoffrey voegt toe: 'Maar er zijn vreemde energieën rondom de tempel.'`;
                    } else if (stateKey === "sluip_ijzige_reus") {
                        text = `Met jouw expertise in sluipen, bewegen jullie geruisloos langs de slapende reus. Een spannende onderneming, maar het lukt! Je reputatie stijgt enorm. Je pakt de tweede scherf zonder gevecht.`;
                    }
                } else if (chosenRole === "Lars") {
                    if (stateKey === "help_vrienden_ijzig") {
                        text = `Samen met Anouk, de genezer, verslaan jullie de elementalen. Anouk, met haar rustgevende aura, geneest je voor 20 gezondheid. 'De tweede scherf is in de IJsgrot hierboven,' zeg jij. 'Maar de ingang is geblokkeerd door een magische barrière.'`;
                    } else if (stateKey === "zwakke_plek_ijs") {
                        text = `Jij merkt een kleine, bijna onzichtbare scheur in het ijs op. Met een strategische slag van jouw wapen breekt de ingang open! Je reputatie stijgt door je observatievermogen.`;
                    } else if (stateKey === "grot_doorgang_ijzig") {
                        text = `De doorgang leidt je naar een open, maar winderige plateau. In de verte zie je Anouk in gevecht met ijzige elementalen. 'Mooi op tijd, ${player.name}!' roep jij.`;
                    } else if (stateKey === "brug_ijzig") {
                        text = `Net op tijd bereik je de overkant voordat de ijsbrug instort! Je ziet Anouk verderop, vechtend tegen ijzige elementalen. 'Daar ben je dan!' roept Anouk, terwijl ze een ijsscherf ontwijkt.`;
                    }
                } else if (chosenRole === "Anouk") {
                    if (stateKey === "help_vrienden_ijzig") {
                        text = `Samen met Lars, de strateeg, verslaan jullie de elementalen. Jij, met jouw rustgevende aura, geneest je voor 20 gezondheid. 'De tweede scherf is in de IJsgrot hierboven,' zegt Lars. 'Maar de ingang is geblokkeerd door een magische barrière.'`;
                    } else if (stateKey === "grot_doorgang_ijzig") {
                        text = `De doorgang leidt je naar een open, maar winderige plateau. In de verte zie je Lars in gevecht met ijzige elementalen. 'Mooi op tijd, ${player.name}!' roept Lars.`;
                    } else if (stateKey === "brug_ijzig") {
                        text = `Net op tijd bereik je de overkant voordat de ijsbrug instort! Je ziet Lars verderop, vechtend tegen ijzige elementalen. 'Daar ben je dan!' roep jij, terwijl je een ijsscherf ontwijkt.`;
                    }
                } else if (chosenRole === "Pleun") {
                    if (stateKey === "volg_rook") {
                        text = `De rook leidt je naar een actieve vulkaan. Jij en Merijn zijn bij de kraterrand, bezig met een vreemd, complex apparaat. Jullie zwaaien enthousiast. Je verliest 10 gezondheid door de intense hitte.`;
                    } else if (stateKey === "pleun_merijn_apparaat") {
                        text = `Jij legt uit: 'Dit is een seismische stabilisator. Merijn heeft hem gebouwd om de vulkaan te kalmeren, zodat we veilig bij het drakenhol kunnen komen. De derde scherf is daar!' Merijn voegt toe: 'Het apparaat heeft alleen nog wat zeldzame mineralen nodig die diep in de vulkaan te vinden zijn.'`;
                    } else if (stateKey === "activeer_stabilisator") {
                        text = `De seismische stabilisator wordt geactiveerd! De vulkaan kalmeert en de weg naar het drakenhol is veilig. Jullie gaan samen verder. 'Dat was kicken!' roep jij.`;
                    }
                } else if (chosenRole === "Merijn") {
                    if (stateKey === "volg_rook") {
                        text = `De rook leidt je naar een actieve vulkaan. Je ziet Pleun en jou bij de kraterrand, bezig met een vreemd, complex apparaat. Jullie zwaaien enthousiast. Je verliest 10 gezondheid door de intense hitte.`;
                    } else if (stateKey === "pleun_merijn_apparaat") {
                        text = `Pleun legt uit: 'Dit is een seismische stabilisator. Jij hebt hem gebouwd om de vulkaan te kalmeren, zodat we veilig bij het drakenhol kunnen komen. De derde scherf is daar!' Jij voegt toe: 'Het apparaat heeft alleen nog wat zeldzame mineralen nodig die diep in de vulkaan te vinden zijn.'`;
                    }
                } else if (chosenRole === "Elizabeth") {
                    if (stateKey === "zoek_derde_scherf") {
                        text = `Twee scherven zijn binnen! Terug in het hoofdkwartier vertel jij, de kalme en verzamelde wachter, dat de laatste scherf in de Vuurlanden ligt, bewaakt door een oude vuurdraak. Pleun en Merijn zijn daar al op verkenning. Ze hebben een plan om de draak te omzeilen.`;
                    }
                } else if (chosenRole === "Esmee") {
                    if (stateKey === "esmee_advies") {
                        text = `Jij, de wijze strateeg van de Regenboogwachters, glimlacht. 'Welkom, ${player.name}. De eerste scherf wordt vermoed in het Fluisterende Woud, diep in het oosten. Wees voorzichtig, het woud is vol gevaren.' Je reputatie stijgt licht.`;
                    } else if (stateKey === "esmee_goud_advies") {
                        text = `Jij fronst je wenkbrauwen. 'Goud is schaars nu. Maar ik heb gehoord dat de oude smid in Oakhaven nog wat klusjes heeft. Of misschien kun je wat spullen verkopen die je niet nodig hebt?'`;
                    } else if (stateKey === "zoek_tweede_scherf") {
                        text = `Met de eerste scherf in handen keer je terug naar het hoofdkwartier. Jason wacht je op. 'Goed gedaan, ${player.name}!' zeg jij. 'De tweede scherf bevindt zich in de IJzige Pieken in het noorden. Lars en Anouk zijn daar al, ze zochten naar een geneeskrachtige plant.'`;
                    }
                } else if (chosenRole === "Jason") {
                    if (stateKey === "jason_eerste_stap") {
                        text = `Jij, de onverschrokken krijger, klopt jezelf op de schouder. 'Geen tijd te verliezen, ${player.name}! De eerste scherf is in het Fluisterende Woud. Ik heb gehoord dat Robin daar al is. Misschien kan hij helpen.'`;
                    } else if (stateKey === "jason_goud_advies") {
                        text = `Jij lacht. 'Goud? Daar vecht je voor! Maar als je echt lui bent, kun je altijd in Oakhaven kijken. Of vraag Robin, die vindt altijd wel iets glimmends.'`;
                    } else if (stateKey === "zoek_tweede_scherf") {
                        text = `Met de eerste scherf in handen keren jullie terug naar het hoofdkwartier. Esmee wacht je op. 'Goed gedaan, ${player.name}!' zegt Esmee. 'De tweede scherf bevindt zich in de IJzige Pieken in het noorden. Lars en Anouk zijn daar al, ze zochten naar een geneeskrachtige plant.'`;
                    }
                }


                // Vervang algemene verwijzingen naar de gekozen NPC
                const regex = new RegExp(chosenRole + "(?![a-z])", "gi"); // Zoek hele woorden
                text = text.replace(regex, "jij");

                // Vervang bezittelijke voornaamwoorden (bijv. Robins expertise -> jouw expertise)
                const regexPossessive = new RegExp(chosenRole + "s\\b", "gi");
                text = text.replace(regexPossessive, "jouw");

                // Vervang 'hij/zij' door 'jij' of 'je' als de context het toelaat (dit is zeer complex en kan fout gaan)
                // Dit is een vereenvoudigde aanpak, perfecte grammatica is hier lastig zonder NLP
                text = text.replace(/\b(hij|zij)\b/gi, (match) => {
                    if (text.includes(chosenRole) && !text.includes("zegt hij") && !text.includes("zegt zij")) { // Voorkom vervangen in dialogen
                        return "jij";
                    }
                    return match;
                });
            }
            return text;
        }


        // De speltoestanden (scenes)
        const gameStates = {
            intro: {
                text: (p) => {
                    let introText = "Een ijzige stilte heeft zich over het Hoofdkwartier van de Regenboogwachters verspreid. De lucht trilt nog na van de catastrofale inslag die het Regenboogkristal versplinterde. Jullie, de legendarische groep Rainbow Dash, zijn de laatsten die de hoop levend kunnen houden.";
                    if (p.chosenNpcRole) {
                        introText += ` Jij, ${p.chosenNpcRole}, staat naast je medewachters Esmee en Jason, klaar voor actie.`;
                    } else {
                        introText += " Esmee, de wijze strateeg, en Jason, de onverschrokken krijger, staan al klaar.";
                    }
                    introText += " Wat is je eerste zet?";
                    return getAdjustedStoryText(introText, 'intro');
                },
                choices: [
                    { text: "Overleg met Esmee over de strategie.", nextState: "esmee_advies" },
                    { text: "Vraag Jason naar de directe actie.", nextState: "jason_eerste_stap" },
                    { text: "Controleer je uitrusting en bereid je voor.", nextState: "voorbereiding_start" }
                ]
            },
            voorbereiding_start: {
                text: (p) => getAdjustedStoryText("Je controleert je riem: een lege buidel, een bot zwaard, en een lichte kleding. Niet bepaald de uitrusting van een held. Je beseft dat je goud nodig hebt. 'Een goede voorbereiding is het halve werk,' mompel je tegen jezelf. Wat nu?", 'voorbereiding_start'),
                choices: [
                    { text: "Vraag Esmee om advies over goud.", nextState: "esmee_goud_advies" },
                    { text: "Vraag Jason of hij nog iets nuttigs heeft.", nextState: "jason_goud_advies" }
                ]
            },
            esmee_goud_advies: {
                text: (p) => getAdjustedStoryText("Esmee fronst haar wenkbrauwen. 'Goud is schaars nu. Maar ik heb gehoord dat de oude smid in Oakhaven nog wat klusjes heeft. Of misschien kun je wat spullen verkopen die je niet nodig hebt?'", 'esmee_goud_advies'),
                choices: [
                    { text: "Reis naar Oakhaven.", nextState: "dorp_oakhaven" },
                    { text: "Zoek nog eens goed rond in het hoofdkwartier.", nextState: "zoek_hoofdkwartier" }
                ]
            },
            jason_goud_advies: {
                text: (p) => getAdjustedStoryText("Jason lacht. 'Goud? Daar vecht je voor! Maar als je echt lui bent, kun je altijd in Oakhaven kijken. Of vraag Robin, die vindt altijd wel iets glimmends.'", 'jason_goud_advies'),
                choices: [
                    { text: "Reis naar Oakhaven.", nextState: "dorp_oakhaven" },
                    { text: "Zoek nog eens goed rond in het hoofdkwartier.", nextState: "zoek_hoofdkwartier" }
                ]
            },
            zoek_hoofdkwartier: {
                text: (p) => getAdjustedStoryText("Je snuffelt rond in stoffige hoekjes van het hoofdkwartier. Onder een omgevallen boekenkast vind je een vergeten zakje met 20 goud! Je reputatie stijgt licht, want opruimen is ook een heldendaad.", 'zoek_hoofdkwartier'),
                effect: () => { player.gold += 20; player.reputation += 2; },
                choices: [
                    { text: "Nu je wat goud hebt, wat is de volgende stap?", nextState: "intro" }
                ]
            },
            dorp_oakhaven: {
                text: (p) => getAdjustedStoryText("Je komt aan in het slaperige dorpje Oakhaven. De geur van versgebakken brood hangt in de lucht. Je ziet een herberg, een smederij en een markt. Waar ga je heen?", 'dorp_oakhaven'),
                choices: [
                    { text: "Naar de smederij voor klusjes.", nextState: "smederij" },
                    { text: "Naar de markt om te handelen.", nextState: "markt" },
                    { text: "De herberg in voor informatie.", nextState: "herberg_oakhaven" }
                ]
            },
            smederij: {
                text: (p) => getAdjustedStoryText("De smid, een norse maar eerlijke man, heeft een klusje: help hem met het sorteren van ijzererts. Het is zwaar werk, maar je verdient 25 goud. Je reputatie stijgt.", 'smederij'),
                effect: () => { player.gold += 25; player.reputation += 5; },
                choices: [
                    { text: "Terug naar het dorp.", nextState: "dorp_oakhaven" }
                ]
            },
            markt: {
                text: (p) => getAdjustedStoryText("Op de markt zie je een handelaar die vreemde snuisterijen verkoopt. Je kunt proberen te handelen. Wat doe je?", 'markt'),
                choices: [
                    { text: "Probeer een zeldzaam voorwerp te kopen (kost 15 goud).", nextState: "markt_koop" },
                    { text: "Probeer een nutteloos voorwerp te verkopen (verdien 5 goud).", nextState: "markt_verkoop" }
                ]
            },
            markt_koop: {
                text: (p) => getAdjustedStoryText("Je koopt een glimmende steen voor 15 goud. De handelaar lacht. 'Mogen de sterren je leiden!' Je hebt de 'Glimmende Steen' verkregen. Je weet nog niet waarvoor het is.", 'markt_koop'),
                effect: () => { player.gold -= 15; player.inventory.push("Glimmende Steen"); },
                choices: [
                    { text: "Terug naar het dorp.", nextState: "dorp_oakhaven" }
                ]
            },
            markt_verkoop: {
                text: (p) => getAdjustedStoryText("Je verkoopt een oud, roestig stuk metaal dat je in je zak vond voor 5 goud. De handelaar haalt zijn schouders op. 'Eén gek staat op, de ander gaat zitten.'", 'markt_verkoop'),
                effect: () => { player.gold += 5; },
                choices: [
                    { text: "Terug naar het dorp.", nextState: "dorp_oakhaven" }
                ]
            },
            herberg_oakhaven: {
                text: (p) => getAdjustedStoryText("De herberg is warm en gezellig. Je ziet een oude, wijze man aan een tafel zitten, en een groepje handelaren bij de bar. Wat doe je?", 'herberg_oakhaven'),
                choices: [
                    { text: "Vraag de oude man naar het kristal.", nextState: "vraag_man_oakhaven" },
                    { text: "Koop een drankje en luister de handelaren af (kost 5 goud).", nextState: "luister_af_handelaren" }
                ]
            },
            vraag_man_oakhaven: {
                text: (p) => getAdjustedStoryText("De oude man kijkt je doordringend aan. 'Het Regenboogkristal is versplinterd... een tragedie. De eerste scherf wordt bewaakt door de Schaduw van het Woud, diep in het Fluisterende Woud. Zoek de Fluisterende Waterval.'", 'vraag_man_oakhaven'),
                choices: [
                    { text: "Bedank de man en ga naar het woud.", nextState: "woud_ingang" }
                ]
            },
            luister_af_handelaren: {
                text: (p) => getAdjustedStoryText("Je koopt een drankje en luistert af. De handelaren praten over een geheime grot achter de Fluisterende Waterval en een zwakke plek van de Schaduw van het Woud: puur licht. Je verliest 5 goud.", 'luister_af_handelaren'),
                effect: () => { player.gold -= 5; player.learnedAboutLight = true; },
                choices: [
                    { text: "Ga naar het Fluisterende Woud.", nextState: "woud_ingang" }
                ]
            },
            esmee_advies: {
                text: (p) => {
                    let text = `Esmee, de wijze strateeg van de Regenboogwachters, glimlacht. 'Welkom, ${p.name}. De eerste scherf wordt vermoed in het Fluisterende Woud, diep in het oosten. Wees voorzichtig, het woud is vol gevaren.' Je reputatie stijgt licht.`;
                    if (p.chosenNpcRole === "Esmee") {
                        text = `Jij, de wijze strateeg van de Regenboogwachters, glimlacht. 'Welkom, ${p.name}. De eerste scherf wordt vermoed in het Fluisterende Woud, diep in het oosten. Wees voorzichtig, het woud is vol gevaren.' Je reputatie stijgt licht.`;
                    }
                    return getAdjustedStoryText(text, 'esmee_advies');
                },
                effect: () => { player.reputation += 5; },
                choices: [
                    { text: "Ga naar het Fluisterende Woud.", nextState: "woud_ingang" },
                    { text: "Vraag Jason ook om advies.", nextState: "jason_eerste_stap" }
                ]
            },
            jason_eerste_stap: {
                text: (p) => {
                    let text = `Jason, de onverschrokken krijger, klopt je op de schouder. 'Geen tijd te verliezen, ${p.name}! De eerste scherf is in het Fluisterende Woud. Ik heb gehoord dat Robin daar al is. Misschien kan hij helpen.'`;
                    if (p.chosenNpcRole === "Jason") {
                        text = `Jij, de onverschrokken krijger, klopt jezelf op de schouder. 'Geen tijd te verliezen, ${p.name}! De eerste scherf is in het Fluisterende Woud. Ik heb gehoord dat Robin daar al is. Misschien kan hij helpen.'`;
                    }
                    return getAdjustedStoryText(text, 'jason_eerste_stap');
                },
                choices: [
                    { text: "Ga naar het Fluisterende Woud.", nextState: "woud_ingang" },
                    { text: "Vraag Esmee om meer details.", nextState: "esmee_advies" }
                ]
            },
            woud_ingang: {
                text: (p) => getAdjustedStoryText("Je betreedt het Fluisterende Woud. De bomen zijn oud en dicht, en het pad is nauwelijks zichtbaar. Je hoort geritsel in de struiken. Wat doe je?", 'woud_ingang'),
                choices: [
                    { text: "Trek je wapen en bereid je voor.", nextState: "woud_gevaar" },
                    { text: "Probeer stilletjes te observeren.", nextState: "woud_observatie" }
                ]
            },
            woud_gevaar: {
                text: (p) => getAdjustedStoryText("Een groepje schaduwwezens springt uit de struiken! Het zijn kleine, maar venijnige wezens. Je vecht dapper, maar verliest 15 gezondheid. Je vindt wel 10 goud.", 'woud_gevaar'),
                effect: () => { player.health -= 15; player.gold += 10; },
                choices: [
                    { text: "Vervolg je pad dieper het woud in.", nextState: "dieper_woud" }
                ]
            },
            woud_observatie: {
                text: (p) => {
                    let text = `Je blijft stil en observeert. Een figuur met een groene cape springt behendig langs de wezens. Het is Robin! Hij knikt je toe. 'Sluipen is de sleutel hier, ${p.name}.' Je reputatie stijgt.`;
                    if (p.chosenNpcRole === "Robin") {
                        text = `Je blijft stil en observeert. Jij, met je groene cape, springt behendig langs de wezens. Je knikt jezelf toe. 'Sluipen is de sleutel hier, ${p.name}.' Je reputatie stijgt.`;
                    }
                    return getAdjustedStoryText(text, 'woud_observatie');
                },
                effect: () => {
                    player.reputation += 10;
                    if (player.chosenNpcRole !== "Robin" && !player.friendsMet.includes("Robin")) { // Voeg alleen toe als speler niet Robin is
                        player.friendsMet.push("Robin");
                    }
                },
                choices: [
                    { text: "Volg " + (player.chosenNpcRole === "Robin" ? "jezelf" : "Robin") + " dieper het woud in.", nextState: "dieper_woud_met_robin" }
                ]
            },
            dieper_woud: {
                text: (p) => getAdjustedStoryText("Dieper in het woud kom je bij een oude, vervallen brug over een diepe kloof. Het ziet er gevaarlijk uit. Wat doe je?", 'dieper_woud'),
                choices: [
                    { text: "Probeer de brug over te steken.", nextState: "brug_oversteken" },
                    { text: "Zoek naar een andere route.", nextState: "andere_route" }
                ]
            },
            dieper_woud_met_robin: {
                text: (p) => {
                    let text = `Robin leidt je door een verborgen pad langs de kloof. 'Deze weg is veiliger,' zegt hij. 'Ik heb gehoord dat Kees en Geoffrey in de buurt zijn, op zoek naar aanwijzingen.'`;
                    if (p.chosenNpcRole === "Robin") {
                        text = `Jij leidt de weg door een verborgen pad langs de kloof. 'Deze weg is veiliger,' zeg je. 'Ik heb gehoord dat Kees en Geoffrey in de buurt zijn, op zoek naar aanwijzingen.'`;
                    }
                    return getAdjustedStoryText(text, 'dieper_woud_met_robin');
                },
                choices: [
                    { text: "Ga verder met " + (player.chosenNpcRole === "Robin" ? "jezelf" : "Robin") + ".", nextState: "ontmoet_kees_geoffrey" }
                ]
            },
            brug_oversteken: {
                text: (p) => getAdjustedStoryText("Je stapt voorzichtig op de brug. Halverwege kraakt hij en stort in! Je valt, maar weet je net vast te grijpen. Je verliest 25 gezondheid en moet een omweg nemen.", 'brug_oversteken'),
                effect: () => { player.health -= 25; },
                choices: [
                    { text: "Zoek een andere route.", nextState: "andere_route" }
                ]
            },
            andere_route: {
                text: (p) => getAdjustedStoryText("Na lang zoeken vind je een smal, rotsachtig pad dat om de kloof heen leidt. Het is een zware klim, maar je bereikt de overkant. Je bent moe, maar ongedeerd.", 'andere_route'),
                choices: [
                    { text: "Vervolg je weg naar de waterval.", nextState: "waterval" }
                ]
            },
            ontmoet_kees_geoffrey: {
                text: (p) => {
                    let text = `Robin leidt je naar een open plek waar Kees, de altijd optimistische, en Geoffrey, de geleerde, bij een kampvuur zitten. 'Ah, ${p.name}!' roept Kees. 'We hebben een kaart gevonden die naar een verborgen tempel leidt waar een scherf zou zijn!' Geoffrey voegt toe: 'Maar er zijn vreemde energieën rondom de tempel.'`;
                    if (p.chosenNpcRole === "Robin") {
                        text = `Jij leidt je weg naar een open plek waar Kees, de altijd optimistische, en Geoffrey, de geleerde, bij een kampvuur zitten. 'Ah, ${p.name}!' roept Kees. 'We hebben een kaart gevonden die naar een verborgen tempel leidt waar een scherf zou zijn!' Geoffrey voegt toe: 'Maar er zijn vreemde energieën rondom de tempel.'`;
                    } else if (p.chosenNpcRole === "Kees") {
                        text = `Robin leidt je naar een open plek waar jij, de altijd optimistische, en Geoffrey, de geleerde, bij een kampvuur zitten. 'Ah, ${p.name}!' roep je. 'We hebben een kaart gevonden die naar een verborgen tempel leidt waar een scherf zou zijn!' Geoffrey voegt toe: 'Maar er zijn vreemde energieën rondom de tempel.'`;
                    } else if (p.chosenNpcRole === "Geoffrey") {
                        text = `Robin leidt je naar een open plek waar Kees, de altijd optimistische, en jij, de geleerde, bij een kampvuur zitten. 'Ah, ${p.name}!' roept Kees. 'We hebben een kaart gevonden die naar een verborgen tempel leidt waar een scherf zou zijn!' Jij voegt toe: 'Maar er zijn vreemde energieën rondom de tempel.'`;
                    }
                    return getAdjustedStoryText(text, 'ontmoet_kees_geoffrey');
                },
                effect: () => {
                    if (player.chosenNpcRole !== "Kees" && !player.friendsMet.includes("Kees")) player.friendsMet.push("Kees");
                    if (player.chosenNpcRole !== "Geoffrey" && !player.friendsMet.includes("Geoffrey")) player.friendsMet.push("Geoffrey");
                },
                choices: [
                    { text: "Ga met hen naar de tempel.", nextState: "tempel_aankomst" },
                    { text: "Vraag Geoffrey naar de energieën.", nextState: "geoffrey_energie" }
                ]
            },
            geoffrey_energie: {
                text: (p) => {
                    let text = `Geoffrey legt uit: 'De energieën duiden op een magische barrière. Alleen degenen met een zuiver hart en een sterke wil kunnen erdoorheen. Of... een speciaal voorwerp, zoals een 'Glimmende Steen'.' Hij kijkt je hoopvol aan.`;
                    if (p.chosenNpcRole === "Geoffrey") {
                        text = `Jij legt uit: 'De energieën duiden op een magische barrière. Alleen degenen met een zuiver hart en een sterke wil kunnen erdoorheen. Of... een speciaal voorwerp, zoals een 'Glimmende Steen'.' Je kijkt hoopvol aan.`;
                    }
                    return getAdjustedStoryText(text, 'geoffrey_energie');
                },
                choices: [
                    { text: "Ga met hen naar de tempel.", nextState: "tempel_aankomst" }
                ]
            },
            tempel_aankomst: {
                text: (p) => getAdjustedStoryText("Jullie komen aan bij een oude, mystieke tempel. Een onzichtbare, trillende barrière blokkeert de ingang. Wat doe je?", 'tempel_aankomst'),
                choices: [
                    { text: "Probeer erdoorheen te dwingen.", nextState: "forceer_barriere" },
                    { text: "Zoek naar een manier om de barrière te deactiveren.", nextState: "deactiveer_barriere" }
                ]
            },
            forceer_barriere: {
                text: (p) => {
                    let text = `Je probeert met brute kracht door de barrière te breken. Een elektrische schok treft je! Je verliest 30 gezondheid. De barrière blijft intact. 'Dat was niet zo slim, ${p.name},' moppert Kees, maar met een glimlach.`;
                    if (p.chosenNpcRole === "Kees") {
                        text = `Je probeert met brute kracht door de barrière te breken. Een elektrische schok treft je! Je verliest 30 gezondheid. De barrière blijft intact. 'Dat was niet zo slim, ${p.name},' mopper je, maar met een glimlach.`;
                    }
                    return getAdjustedStoryText(text, 'forceer_barriere');
                },
                effect: () => { player.health -= 30; },
                choices: [
                    { text: "Zoek een andere manier.", nextState: "deactiveer_barriere" }
                ]
            },
            deactiveer_barriere: {
                text: (p) => {
                    let text = `Geoffrey herinnert zich een oud ritueel. Met de hulp van Robin en Kees vinden jullie drie pilaren rondom de tempel. Je activeert ze en de barrière verdwijnt! Je reputatie stijgt enorm. Als je de 'Glimmende Steen' hebt, voel je dat deze resoneert met de energie van de tempel en je reputatie nog meer stijgt.`;
                    if (p.chosenNpcRole === "Geoffrey") {
                        text = `Jij herinnert je een oud ritueel. Met de hulp van Robin en Kees vinden jullie drie pilaren rondom de tempel. Je activeert ze en de barrière verdwijnt! Je reputatie stijgt enorm. Als je de 'Glimmende Steen' hebt, voel je dat deze resoneert met de energie van de tempel en je reputatie nog meer stijgt.`;
                    }
                    return getAdjustedStoryText(text, 'deactiveer_barriere');
                },
                effect: () => {
                    player.reputation += 20;
                    if (player.inventory.includes("Glimmende Steen")) {
                        player.reputation += 10; // Extra reputatie
                    }
                },
                choices: [
                    { text: "Ga de tempel binnen.", nextState: "tempel_binnen" }
                ]
            },
            tempel_binnen: {
                text: (p) => getAdjustedStoryText("Binnenin de tempel vinden jullie een altaar. Bovenop ligt de eerste scherf van het Regenboogkristal! Maar terwijl je het pakt, verschijnt een schaduwbewaker, groter en dreigender dan de wezens in het woud. Wat doe je?", 'tempel_binnen'),
                choices: [
                    { text: "Vecht tegen de bewaker!", nextState: "tempel_bewaker_gevecht" }
                ]
            },
            tempel_bewaker_gevecht: {
                text: (p) => {
                    let friendsInFight = [];
                    if (p.chosenNpcRole !== "Jason" && p.friendsMet.includes("Jason")) friendsInFight.push("Jason");
                    if (p.chosenNpcRole !== "Renske" && p.friendsMet.includes("Renske")) friendsInFight.push("Renske");
                    if (p.chosenNpcRole !== "Robin" && p.friendsMet.includes("Robin")) friendsInFight.push("Robin");
                    if (p.chosenNpcRole !== "Kees" && p.friendsMet.includes("Kees")) friendsInFight.push("Kees");
                    if (p.chosenNpcRole !== "Geoffrey" && p.friendsMet.includes("Geoffrey")) friendsInFight.push("Geoffrey");

                    let text = `De bewaker is sterk! Gelukkig zijn ${friendsInFight.join(' en ')} er om je te helpen! Jullie vechten samen. Je verliest 20 gezondheid, maar de bewaker is verslagen! Je bemachtigt de eerste kristalscherf.`;
                    if (friendsInFight.length === 0) {
                        text = `De bewaker is sterk! Je vecht alleen, maar met al je moed versla je hem! Je verliest 20 gezondheid en bemachtigt de eerste kristalscherf.`;
                    }
                    return getAdjustedStoryText(text, 'tempel_bewaker_gevecht');
                },
                effect: () => {
                    player.health -= 20;
                    player.crystalShards += 1;
                    player.reputation += 15;
                    // Voeg vrienden toe als ze nog niet zijn ontmoet EN niet de gekozen rol zijn
                    if (player.chosenNpcRole !== "Jason" && !player.friendsMet.includes("Jason")) player.friendsMet.push("Jason");
                    if (player.chosenNpcRole !== "Renske" && !player.friendsMet.includes("Renske")) player.friendsMet.push("Renske");
                },
                choices: [
                    { text: "Nu de volgende scherf vinden!", nextState: "zoek_tweede_scherf" }
                ]
            },
            zoek_tweede_scherf: {
                text: (p) => {
                    let text = `Met de eerste scherf in handen keren jullie terug naar het hoofdkwartier. Esmee en Jason wachten jullie op. 'Goed gedaan, ${p.name}!' zegt Esmee. 'De tweede scherf bevindt zich in de IJzige Pieken in het noorden. Lars en Anouk zijn daar al, ze zochten naar een geneeskrachtige plant.'`;
                    if (p.chosenNpcRole === "Esmee") {
                        text = `Met de eerste scherf in handen keer je terug naar het hoofdkwartier. Jason wacht je op. 'Goed gedaan, ${p.name}!' zeg jij. 'De tweede scherf bevindt zich in de IJzige Pieken in het noorden. Lars en Anouk zijn daar al, ze zochten naar een geneeskrachtige plant.'`;
                    } else if (p.chosenNpcRole === "Jason") {
                        text = `Met de eerste scherf in handen keren jullie terug naar het hoofdkwartier. Esmee wacht je op. 'Goed gedaan, ${p.name}!' zegt Esmee. 'De tweede scherf bevindt zich in de IJzige Pieken in het noorden. Lars en Anouk zijn daar al, ze zochten naar een geneeskrachtige plant.'`;
                    }
                    return getAdjustedStoryText(text, 'zoek_tweede_scherf');
                },
                choices: [
                    { text: "Reis naar de IJzige Pieken.", nextState: "ijzige_pieken_aankomst" }
                ]
            },
            ijzige_pieken_aankomst: {
                text: (p) => getAdjustedStoryText("De wind snijdt door je kleding terwijl je de IJzige Pieken betreedt. Het pad is verraderlijk en ijzig. Je ziet voetsporen in de sneeuw die naar een gevaarlijk uitziende ijsbrug leiden. Wat doe je?", 'ijzige_pieken_aankomst'),
                choices: [
                    { text: "Volg de voetsporen over de ijsbrug.", nextState: "volg_voetsporen_ijzig" },
                    { text: "Zoek een veiliger pad om de ijsbrug heen.", nextState: "veiliger_pad_ijzig" }
                ]
            },
            volg_voetsporen_ijzig: {
                text: (p) => getAdjustedStoryText("De voetsporen leiden je naar een smalle ijsbrug. Terwijl je oversteekt, begint de brug te kraken! Je moet snel zijn. Je verliest 10 gezondheid door de kou en de val.", 'volg_voetsporen_ijzig'),
                effect: () => { player.health -= 10; },
                choices: [
                    { text: "Ren over de brug!", nextState: "brug_ijzig" }
                ]
            },
            veiliger_pad_ijzig: {
                text: (p) => getAdjustedStoryText("Je zoekt een omweg en vindt een grot die beschutting biedt tegen de wind. Binnenin ontdek je een verborgen doorgang. Het kost meer tijd, maar je reputatie stijgt door je voorzichtigheid.", 'veiliger_pad_ijzig'),
                effect: () => { player.reputation += 10; },
                choices: [
                    { text: "Ga de doorgang in.", nextState: "grot_doorgang_ijzig" }
                ]
            },
            brug_ijzig: {
                text: (p) => {
                    let text = `Net op tijd bereik je de overkant voordat de ijsbrug instort! Je ziet Lars en Anouk verderop, vechtend tegen ijzige elementalen. 'Daar ben je dan!' roept Anouk, terwijl ze een ijsscherf ontwijkt.`;
                    if (p.chosenNpcRole === "Lars") {
                        text = `Net op tijd bereik je de overkant voordat de ijsbrug instort! Je ziet Anouk verderop, vechtend tegen ijzige elementalen. 'Daar ben je dan!' roept Anouk, terwijl ze een ijsscherf ontwijkt.`;
                    } else if (p.chosenNpcRole === "Anouk") {
                        text = `Net op tijd bereik je de overkant voordat de ijsbrug instort! Je ziet Lars verderop, vechtend tegen ijzige elementalen. 'Daar ben je dan!' roep je, terwijl je een ijsscherf ontwijkt.`;
                    }
                    return getAdjustedStoryText(text, 'brug_ijzig');
                },
                effect: () => {
                    if (player.chosenNpcRole !== "Lars" && !player.friendsMet.includes("Lars")) player.friendsMet.push("Lars");
                    if (player.chosenNpcRole !== "Anouk" && !player.friendsMet.includes("Anouk")) player.friendsMet.push("Anouk");
                },
                choices: [
                    { text: "Help Lars en Anouk.", nextState: "help_vrienden_ijzig" }
                ]
            },
            grot_doorgang_ijzig: {
                text: (p) => {
                    let text = `De doorgang leidt je naar een open, maar winderige plateau. In de verte zie je Lars en Anouk in gevecht met ijzige elementalen. 'Mooi op tijd, ${p.name}!' roept Lars.`;
                    if (p.chosenNpcRole === "Lars") {
                        text = `De doorgang leidt je naar een open, maar winderige plateau. In de verte zie je Anouk in gevecht met ijzige elementalen. 'Mooi op tijd, ${p.name}!' roep jij.`;
                    } else if (p.chosenNpcRole === "Anouk") {
                        text = `De doorgang leidt je naar een open, maar winderige plateau. In de verte zie je Lars in gevecht met ijzige elementalen. 'Mooi op tijd, ${p.name}!' roept Lars.`;
                    }
                    return getAdjustedStoryText(text, 'grot_doorgang_ijzig');
                },
                effect: () => {
                    if (player.chosenNpcRole !== "Lars" && !player.friendsMet.includes("Lars")) player.friendsMet.push("Lars");
                    if (player.chosenNpcRole !== "Anouk" && !player.friendsMet.includes("Anouk")) player.friendsMet.push("Anouk");
                },
                choices: [
                    { text: "Help Lars en Anouk.", nextState: "help_vrienden_ijzig" }
                ]
            },
            help_vrienden_ijzig: {
                text: (p) => {
                    let text = `Samen met Lars, de strateeg, en Anouk, de genezer, verslaan jullie de elementalen. Anouk, met haar rustgevende aura, geneest je voor 20 gezondheid. 'De tweede scherf is in de IJsgrot hierboven,' zegt Lars. 'Maar de ingang is geblokkeerd door een magische barrière.'`;
                    if (p.chosenNpcRole === "Lars") {
                        text = `Samen met Anouk, de genezer, verslaan jullie de elementalen. Anouk, met haar rustgevende aura, geneest je voor 20 gezondheid. 'De tweede scherf is in de IJsgrot hierboven,' zeg jij. 'Maar de ingang is geblokkeerd door een magische barrière.'`;
                    } else if (p.chosenNpcRole === "Anouk") {
                        text = `Samen met Lars, de strateeg, verslaan jullie de elementalen. Jij, met jouw rustgevende aura, geneest je voor 20 gezondheid. 'De tweede scherf is in de IJsgrot hierboven,' zegt Lars. 'Maar de ingang is geblokkeerd door een magische barrière.'`;
                    }
                    return getAdjustedStoryText(text, 'help_vrienden_ijzig');
                },
                effect: () => { player.health = Math.min(100, player.health + 20); }, // Genees, max 100
                choices: [
                    { text: "Zoek een manier om de grot te openen.", nextState: "ijsgrot_ingang" }
                ]
            },
            ijsgrot_ingang: {
                text: (p) => getAdjustedStoryText("De ingang van de IJsgrot is bedekt met een dikke laag magisch ijs. Het straalt kou uit. Wat doe je?", 'ijsgrot_ingang'),
                choices: [
                    { text: "Probeer het ijs te smelten met brute kracht of magie (als je die hebt).", nextState: "smelt_ijs" },
                    { text: "Zoek naar een zwakke plek in het ijs of een alternatieve ingang.", nextState: "zwakke_plek_ijs" }
                ]
            },
            smelt_ijs: {
                text: (p) => {
                    let text = `Je probeert het ijs te smelten met je eigen energie. Het werkt, maar kost je 15 gezondheid. De grot is open! Lars knikt waarderend.`;
                    if (p.chosenNpcRole === "Lars") {
                        text = `Jij probeert het ijs te smelten met je eigen energie. Het werkt, maar kost je 15 gezondheid. De grot is open! Anouk knikt waarderend.`;
                    }
                    return getAdjustedStoryText(text, 'smelt_ijs');
                },
                effect: () => { player.health -= 15; },
                choices: [
                    { text: "Ga de IJsgrot in.", nextState: "ijsgrot_binnen" }
                ]
            },
            zwakke_plek_ijs: {
                text: (p) => {
                    let text = `Lars merkt een kleine, bijna onzichtbare scheur in het ijs op. Met een strategische slag van zijn wapen (of jouw wapen, als je geen Lars hebt) breekt de ingang open! Je reputatie stijgt door je observatievermogen.`;
                    if (p.chosenNpcRole === "Lars") {
                        text = `Jij merkt een kleine, bijna onzichtbare scheur in het ijs op. Met een strategische slag van jouw wapen breekt de ingang open! Je reputatie stijgt door je observatievermogen.`;
                    }
                    return getAdjustedStoryText(text, 'zwakke_plek_ijs');
                },
                effect: () => { player.reputation += 10; },
                choices: [
                    { text: "Ga de IJsgrot in.", nextState: "ijsgrot_binnen" }
                ]
            },
            ijsgrot_binnen: {
                text: (p) => getAdjustedStoryText("Binnenin de IJsgrot is het bitterkoud. Adem condenseert in de lucht. In het midden zie je de tweede kristalscherf, bewaakt door een kolossale ijzige reus die langzaam ademt. Wat doe je?", 'ijsgrot_binnen'),
                choices: [
                    { text: "Val de ijzige reus aan!", nextState: "ijzige_reus_gevecht" },
                    { text: "Probeer langs de reus te sluipen (als je Robin hebt ontmoet).", nextState: "sluip_ijzige_reus" }
                ]
            },
            sluip_ijzige_reus: {
                text: (p) => {
                    if (p.friendsMet.includes("Robin") || p.chosenNpcRole === "Robin") {
                        return getAdjustedStoryText(`Met ${p.chosenNpcRole === "Robin" ? "jouw" : "Robin's"} expertise in sluipen, bewegen jullie geruisloos langs de slapende reus. Een spannende onderneming, maar het lukt! Je reputatie stijgt enorm. Je pakt de tweede scherf zonder gevecht.`, 'sluip_ijzige_reus');
                    } else {
                        return getAdjustedStoryText(`Je probeert te sluipen, maar je bent niet zo behendig als Robin. De reus wordt wakker! Je verliest 10 gezondheid en moet vechten.`, 'sluip_ijzige_reus');
                    }
                },
                effect: () => {
                    if (player.friendsMet.includes("Robin") || player.chosenNpcRole === "Robin") {
                        player.crystalShards += 1;
                        player.reputation += 25;
                        updateGame('zoek_derde_scherf'); // Direct naar volgende fase
                    } else {
                        player.health -= 10;
                        updateGame('ijzige_reus_gevecht'); // Terug naar gevecht
                    }
                },
                choices: [
                    { text: "Ga verder.", nextState: "continue_after_sluip_reus" }
                ]
            },
            continue_after_sluip_reus: {
                text: (p) => getAdjustedStoryText("...", 'continue_after_sluip_reus'), // Placeholder, wordt overschreven door effect
                choices: [] // Placeholder
            },
            ijzige_reus_gevecht: {
                text: (p) => {
                    let friendsInFight = [];
                    if (p.chosenNpcRole !== "Lars" && p.friendsMet.includes("Lars")) friendsInFight.push("Lars");
                    if (p.chosenNpcRole !== "Anouk" && p.friendsMet.includes("Anouk")) friendsInFight.push("Anouk");

                    let text = `De ijzige reus is langzaam maar krachtig! Zijn vuisten zijn als rotsblokken. Samen met ${friendsInFight.join(' en ')} vechten jullie. Je verliest 25 gezondheid, maar de reus valt! Je pakt de tweede kristalscherf.`;
                    if (friendsInFight.length === 0) {
                        text = `De ijzige reus is langzaam maar krachtig! Zijn vuisten zijn als rotsblokken. Je vecht alleen, maar met al je moed versla je hem! Je verliest 25 gezondheid en pakt de tweede kristalscherf.`;
                    }
                    return getAdjustedStoryText(text, 'ijzige_reus_gevecht');
                },
                effect: () => { player.health -= 25; player.crystalShards += 1; player.reputation += 15; },
                choices: [
                    { text: "Tijd voor de laatste scherf!", nextState: "zoek_derde_scherf" }
                ]
            },
            zoek_derde_scherf: {
                text: (p) => {
                    let text = `Twee scherven zijn binnen! Terug in het hoofdkwartier vertelt Elizabeth, de kalme en verzamelde wachter, dat de laatste scherf in de Vuurlanden ligt, bewaakt door een oude vuurdraak. Pleun en Merijn zijn daar al op verkenning. Ze hebben een plan om de draak te omzeilen.`;
                    if (p.chosenNpcRole === "Elizabeth") {
                        text = `Twee scherven zijn binnen! Terug in het hoofdkwartier vertel jij, de kalme en verzamelde wachter, dat de laatste scherf in de Vuurlanden ligt, bewaakt door een oude vuurdraak. Pleun en Merijn zijn daar al op verkenning. Ze hebben een plan om de draak te omzeilen.`;
                    }
                    return getAdjustedStoryText(text, 'zoek_derde_scherf');
                },
                effect: () => { if (player.chosenNpcRole !== "Elizabeth" && !player.friendsMet.includes("Elizabeth")) player.friendsMet.push("Elizabeth"); },
                choices: [
                    { text: "Reis naar de Vuurlanden.", nextState: "vuurlanden_aankomst" }
                ]
            },
            vuurlanden_aankomst: {
                text: (p) => getAdjustedStoryText("De hitte van de Vuurlanden slaat je tegemoet. De grond is gebarsten en lava stroomt in de verte. Je ziet rookpluimen opstijgen van een actieve vulkaan, en in de verte een oude, verlaten observatiepost. Wat doe je?", 'vuurlanden_aankomst'),
                choices: [
                    { text: "Volg de rookpluimen naar de vulkaan.", nextState: "volg_rook" },
                    { text: "Onderzoek de verlaten observatiepost.", nextState: "observatiepost" }
                ]
            },
            volg_rook: {
                text: (p) => {
                    let text = `De rook leidt je naar een actieve vulkaan. Je ziet Pleun en Merijn bij de kraterrand, bezig met een vreemd, complex apparaat. Ze zwaaien enthousiast. Je verliest 10 gezondheid door de intense hitte.`;
                    if (p.chosenNpcRole === "Pleun") {
                        text = `De rook leidt je naar een actieve vulkaan. Jij en Merijn zijn bij de kraterrand, bezig met een vreemd, complex apparaat. Jullie zwaaien enthousiast. Je verliest 10 gezondheid door de intense hitte.`;
                    } else if (p.chosenNpcRole === "Merijn") {
                        text = `De rook leidt je naar een actieve vulkaan. Je ziet Pleun en jou bij de kraterrand, bezig met een vreemd, complex apparaat. Jullie zwaaien enthousiast. Je verliest 10 gezondheid door de intense hitte.`;
                    }
                    return getAdjustedStoryText(text, 'volg_rook');
                },
                effect: () => {
                    player.health -= 10;
                    if (player.chosenNpcRole !== "Pleun" && !player.friendsMet.includes("Pleun")) player.friendsMet.push("Pleun");
                    if (player.chosenNpcRole !== "Merijn" && !player.friendsMet.includes("Merijn")) player.friendsMet.push("Merijn");
                },
                choices: [
                    { text: "Vraag wat ze aan het doen zijn.", nextState: "pleun_merijn_apparaat" }
                ]
            },
            observatiepost: {
                text: (p) => getAdjustedStoryText("De observatiepost is stoffig en verlaten, maar de instrumenten zijn nog intact. Je vindt een logboek dat spreekt over 'seismische verstoringen' en 'een zwakke plek in de drakenhuid, blootgesteld door extreme hitte'. Je reputatie stijgt door je onderzoek.", 'observatiepost'),
                effect: () => { player.reputation += 10; player.learnedAboutDragonWeakness = true; },
                choices: [
                    { text: "Ga verder richting de vulkaan.", nextState: "volg_rook" }
                ]
            },
            pleun_merijn_apparaat: {
                text: (p) => {
                    let text = `Pleun legt uit: 'Dit is een seismische stabilisator. Merijn heeft hem gebouwd om de vulkaan te kalmeren, zodat we veilig bij het drakenhol kunnen komen. De derde scherf is daar!' Merijn voegt toe: 'Het apparaat heeft alleen nog wat zeldzame mineralen nodig die diep in de vulkaan te vinden zijn.'`;
                    if (p.chosenNpcRole === "Pleun") {
                        text = `Jij legt uit: 'Dit is een seismische stabilisator. Merijn heeft hem gebouwd om de vulkaan te kalmeren, zodat we veilig bij het drakenhol kunnen komen. De derde scherf is daar!' Merijn voegt toe: 'Het apparaat heeft alleen nog wat zeldzame mineralen nodig die diep in de vulkaan te vinden zijn.'`;
                    } else if (p.chosenNpcRole === "Merijn") {
                        text = `Pleun legt uit: 'Dit is een seismische stabilisator. Jij hebt hem gebouwd om de vulkaan te kalmeren, zodat we veilig bij het drakenhol kunnen komen. De derde scherf is daar!' Jij voegt toe: 'Het apparaat heeft alleen nog wat zeldzame mineralen nodig die diep in de vulkaan te vinden zijn.'`;
                    }
                    return getAdjustedStoryText(text, 'pleun_merijn_apparaat');
                },
                choices: [
                    { text: "Help ze de mineralen te vinden.", nextState: "vind_mineralen" },
                    { text: "Ga zelf naar het drakenhol (als je de kaart of info hebt).", nextState: "drakenhol_kaart_of_info" }
                ]
            },
            vind_mineralen: {
                text: (p) => {
                    let text = `Samen met Pleun en Merijn daal je af in de vulkaan. Het is gevaarlijk, maar Merijn's inventiviteit en Pleun's middelen helpen jullie. Je verliest 15 gezondheid, maar vindt de mineralen. Je reputatie stijgt door jullie teamwerk.`;
                    if (p.chosenNpcRole === "Pleun") {
                        text = `Samen met Merijn daal je af in de vulkaan. Het is gevaarlijk, maar Merijn's inventiviteit en jouw middelen helpen jullie. Je verliest 15 gezondheid, maar vindt de mineralen. Je reputatie stijgt door jullie teamwerk.`;
                    } else if (p.chosenNpcRole === "Merijn") {
                        text = `Samen met Pleun daal je af in de vulkaan. Het is gevaarlijk, maar jouw inventiviteit en Pleun's middelen helpen jullie. Je verliest 15 gezondheid, maar vindt de mineralen. Je reputatie stijgt door jullie teamwerk.`;
                    }
                    return getAdjustedStoryText(text, 'vind_mineralen');
                },
                effect: () => { player.health -= 15; player.reputation += 15; },
                choices: [
                    { text: "Activeer de stabilisator.", nextState: "activeer_stabilisator" }
                ]
            },
            activeer_stabilisator: {
                text: (p) => {
                    let text = `De seismische stabilisator wordt geactiveerd! De vulkaan kalmeert en de weg naar het drakenhol is veilig. Jullie gaan samen verder. 'Dat was kicken!' roept Pleun.`;
                    if (p.chosenNpcRole === "Pleun") {
                        text = `De seismische stabilisator wordt geactiveerd! De vulkaan kalmeert en de weg naar het drakenhol is veilig. Jullie gaan samen verder. 'Dat was kicken!' roep jij.`;
                    }
                    return getAdjustedStoryText(text, 'activeer_stabilisator');
                },
                choices: [
                    { text: "Ga naar het drakenhol.", nextState: "drakenhol_ingang" }
                ]
            },
            drakenhol_kaart_of_info: {
                text: (p) => getAdjustedStoryText("Je besluit alleen verder te gaan, gewapend met de kennis die je hebt opgedaan (of de kaart, als je die hebt). Je vindt de ingang van het drakenhol. Een diep, hees gegrom klinkt van binnenuit. Wat doe je?", 'drakenhol_kaart_of_info'),
                choices: [
                    { text: "Ga het drakenhol in.", nextState: "drakenhol_ingang" }
                ]
            },
            drakenhol_ingang: {
                text: (p) => getAdjustedStoryText("Binnenin het drakenhol is het een broeierige hitte. In het midden van een lavameer ligt de laatste kristalscherf, bewaakt door een eeuwenoude, vuurspuwende draak! Zijn ogen gloeien als sintels. Wat doe je?", 'drakenhol_ingang'),
                choices: [
                    { text: "Vecht tegen de draak!", nextState: "draak_gevecht_eind" },
                    { text: "Probeer zijn zwakke plek te benutten (als je die hebt ontdekt).", nextState: "draak_zwakke_plek" }
                ]
            },
            draak_zwakke_plek: {
                text: (p) => {
                    let text = `Je herinnert je de informatie over de zwakke plek van de draak. Je richt je aanval op die ene plek. De draak brult van pijn! Het gevecht is zwaar, maar minder dodelijk. Je verliest 20 gezondheid. De draak is verslagen! Je bemachtigt de laatste kristalscherf.`;
                    if (p.learnedAboutDragonWeakness) {
                        text = `Je herinnert je de informatie over de zwakke plek van de draak. Je richt je aanval op die ene plek. De draak brult van pijn! Het gevecht is zwaar, maar minder dodelijk. Je verliest 20 gezondheid. De draak is verslagen! Je bemachtigt de laatste kristalscherf.`;
                    } else {
                        text = `Je probeert een zwakke plek te vinden, maar de draak is te snel. Je verliest 30 gezondheid en moet direct vechten!`;
                    }
                    return getAdjustedStoryText(text, 'draak_zwakke_plek');
                },
                effect: () => {
                    if (player.learnedAboutDragonWeakness) {
                        player.health -= 20;
                        player.crystalShards += 1;
                        player.reputation += 30; // Extra reputatie voor slimheid
                        updateGame('alle_scherven_gevonden');
                    } else {
                        player.health -= 30; // Minder effectief zonder kennis
                        updateGame('draak_gevecht_eind');
                    }
                },
                choices: [
                    { text: "Ga verder.", nextState: "continue_after_dragon_weakness" }
                ]
            },
            continue_after_dragon_weakness: {
                text: (p) => getAdjustedStoryText("...", 'continue_after_dragon_weakness'), // Placeholder
                choices: [] // Placeholder
            },
            draak_gevecht_eind: {
                text: (p) => {
                    let friendsInFight = [];
                    if (p.chosenNpcRole !== "Pleun" && p.friendsMet.includes("Pleun")) friendsInFight.push("Pleun");
                    if (p.chosenNpcRole !== "Merijn" && p.friendsMet.includes("Merijn")) friendsInFight.push("Merijn");

                    let text = `De vuurdraak is een machtige tegenstander! (Je gezondheid: ${p.health}). Samen met ${friendsInFight.join(' en ')} vechten jullie, wat het gevecht aanzienlijk vergemakkelijkt. Je verliest 40 gezondheid, maar de draak is verslagen! Je bemachtigt de laatste kristalscherf.`;
                    if (friendsInFight.length === 0) {
                        text = `De vuurdraak is een machtige tegenstander! (Je gezondheid: ${p.health}). Je vecht alleen, maar met al je moed versla je hem! Je verliest 40 gezondheid en bemachtigt de laatste kristalscherf.`;
                    }
                    return getAdjustedStoryText(text, 'draak_gevecht_eind');
                },
                effect: () => {
                    player.health -= 40;
                    player.crystalShards += 1;
                    player.reputation += 20;
                },
                choices: [
                    { text: "Keer terug naar het hoofdkwartier.", nextState: "alle_scherven_gevonden" }
                ]
            },
            alle_scherven_gevonden: {
                text: (p) => {
                    let allFriends = npcCharacters.map(char => char.name).filter(name => name !== p.chosenNpcRole);
                    let friendsList = allFriends.join(', ');
                    let text = `Met alle drie de scherven in handen keer je terug naar het hoofdkwartier. Een golf van opluchting en hoop stroomt door de zaal. De hele groep van de Regenboogwachters - ${friendsList} - wacht op je. Hun gezichten stralen van trots. Het is tijd om het kristal te herstellen!`;
                    return getAdjustedStoryText(text, 'alle_scherven_gevonden');
                },
                choices: [
                    { text: "Herstel het Regenboogkristal.", nextState: "kristal_herstellen" }
                ]
            },
            kristal_herstellen: {
                text: (p) => getAdjustedStoryText("Jullie plaatsen de drie scherven op het altaar. Een regenboog van licht schiet omhoog en het kristal vormt zich weer tot één geheel! De kracht stroomt door jullie heen, de kleuren keren terug in de wereld. De duistere schaduw wijkt. De wereld is gered!", 'kristal_herstellen'),
                choices: [
                    { text: "Einde.", nextState: "end_win" }
                ]
            },
            end_win: {
                text: (p) => getAdjustedStoryText(`Gefeliciteerd, ${p.name}! Samen met de Regenboogwachters heb je het kristal hersteld en de wereld gered! Jouw naam zal voor altijd voortleven in de kronieken als een ware held van Rainbow Dash. De toekomst is weer kleurrijk!`, 'end_win'),
                isEnd: true,
                win: true
            },
            end_lose_health: {
                text: (p) => getAdjustedStoryText(`Je gezondheid is te laag. Je valt neer, overweldigd door je verwondingen. Jouw avontuur eindigt hier, ${p.name}. De Regenboogwachters zullen een andere held moeten vinden, hopend dat zij succesvoller zijn. De schaduw blijft hangen...`, 'end_lose_health'),
                isEnd: true,
                win: false
            },
            end_bewaker_te_sterk: {
                text: (p) => getAdjustedStoryText(`De bewaker was te sterk. Je bent verslagen. Jouw avontuur eindigt hier, ${p.name}. Zonder jou zal het kristal misschien nooit hersteld worden.`, 'end_bewaker_te_sterk'),
                isEnd: true,
                win: false
            },
            // Random Events
            random_event_1: {
                text: (p) => getAdjustedStoryText("Terwijl je verder reist, kom je een verdwaalde handelaar tegen. Hij biedt je een 'magisch' drankje aan voor 10 goud. Wat doe je?", 'random_event_1'),
                choices: [
                    { text: "Koop het drankje (10 goud).", nextState: "random_event_1_koop" },
                    { text: "Negeer hem en ga verder.", nextState: "random_event_continue" }
                ]
            },
            random_event_1_koop: {
                text: (p) => {
                    if (Math.random() < 0.5) {
                        player.health += 15;
                        return getAdjustedStoryText("Het drankje smaakt vreemd, maar je voelt je direct beter! Je gezondheid stijgt met 15. De handelaar knipoogt en verdwijnt. (+15 Gezondheid)", 'random_event_1_koop');
                    } else {
                        player.health -= 5;
                        return getAdjustedStoryText("Het drankje smaakt naar oude sokken en je voelt je een beetje misselijk. Je verliest 5 gezondheid. De handelaar lacht en verdwijnt. (-5 Gezondheid)", 'random_event_1_koop');
                    }
                },
                effect: () => { player.gold -= 10; },
                choices: [
                    { text: "Ga verder met je reis.", nextState: "return_from_random_event" }
                ]
            },
            random_event_2: {
                text: (p) => getAdjustedStoryText("Je stuit op een kleine, verlaten schatkist. Het slot is roestig. Wat doe je?", 'random_event_2'),
                choices: [
                    { text: "Probeer het slot te forceren.", nextState: "random_event_2_forceer" },
                    { text: "Laat de kist met rust.", nextState: "random_event_continue" }
                ]
            },
            random_event_2_forceer: {
                text: (p) => {
                    if (Math.random() < 0.7) { // 70% kans op succes
                        player.gold += 30;
                        return getAdjustedStoryText("Met een harde ruk forceer je het slot open! Binnenin vind je 30 goud! (+30 Goud)", 'random_event_2_forceer');
                    } else {
                        player.health -= 5;
                        return getAdjustedStoryText("Het slot is sterker dan verwacht. Je bezeert je hand en verliest 5 gezondheid. De kist blijft gesloten. (-5 Gezondheid)", 'random_event_2_forceer');
                    }
                },
                choices: [
                    { text: "Ga verder met je reis.", nextState: "return_from_random_event" }
                ]
            },
            random_event_continue: {
                text: (p) => getAdjustedStoryText("Je besluit geen risico te nemen en vervolgt je weg. Het avontuur wacht!", 'random_event_continue'),
                choices: [
                    { text: "Ga verder met je reis.", nextState: "return_from_random_event" }
                ]
            },
            return_from_random_event: {
                text: (p) => getAdjustedStoryText("Je bent weer op het juiste pad. Het avontuur gaat verder.", 'return_from_random_event'),
                choices: [] // Dit wordt dynamisch ingevuld
            }
        };

        let currentGameState = "intro";
        let previousMainGameState = null; // Om terug te keren na een random event

        // Functie om de game state te updaten en weer te geven
        function updateGame(stateKey) {
            // Controleer op game over door gezondheid VOORDAT de nieuwe state wordt verwerkt
            if (player.health <= 0) {
                endGame("end_lose_health");
                return;
            }

            const state = gameStates[stateKey];
            if (!state) {
                console.error("Onbekende speltoestand:", stateKey);
                return;
            }

            // Pas effecten toe als die er zijn
            if (state.effect) {
                state.effect();
            }

            // Update UI met nieuwe stats
            playerNameDisplay.textContent = player.name;
            playerHealthDisplay.textContent = player.health;
            playerGoldDisplay.textContent = player.gold;
            playerShardsDisplay.textContent = player.crystalShards;
            playerReputationDisplay.textContent = player.reputation;


            // Controleer opnieuw op game over na effecten (als een effect gezondheid verlaagt)
            if (player.health <= 0) {
                endGame("end_lose_health");
                return;
            }

            // Toon de tekst en keuzes
            // Gebruik de getAdjustedStoryText helper voor dynamische tekst
            storyTextElement.textContent = typeof state.text === 'function' ? state.text(player) : getAdjustedStoryText(state.text, stateKey);
            choicesElement.innerHTML = ''; // Maak keuzes leeg

            if (state.isEnd) {
                endGame(stateKey);
                return;
            }

            // Speciale logica voor random events
            if (stateKey.startsWith("random_event_") && stateKey !== "return_from_random_event") {
                // Als het een random event is, zorg dat de keuzes terugleiden naar de return state
                state.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choice.text;
                    button.addEventListener('click', () => {
                        updateGame(choice.nextState);
                    });
                    choicesElement.appendChild(button);
                });
            } else if (stateKey === "return_from_random_event") {
                // Na een random event, keer terug naar de vorige hoofdstaat
                const button = document.createElement('button');
                button.classList.add('choice-button');
                button.textContent = "Ga verder met je avontuur.";
                button.addEventListener('click', () => {
                    updateGame(previousMainGameState);
                });
                choicesElement.appendChild(button);
            } else {
                // Normale speltoestanden
                state.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choice.text;
                    button.addEventListener('click', () => {
                        // Sla de huidige hoofdstaat op voordat we naar een random event gaan
                        if (Math.random() < 0.2 && choice.nextState !== "end_win" && choice.nextState !== "end_lose_health" && choice.nextState !== "end_bewaker_te_sterk") { // 20% kans op random event
                            previousMainGameState = choice.nextState;
                            const randomEventKeys = ["random_event_1", "random_event_2"];
                            const randomEvent = randomEventKeys[Math.floor(Math.random() * randomEventKeys.length)];
                            updateGame(randomEvent);
                        } else {
                            updateGame(choice.nextState);
                        }
                    });
                    choicesElement.appendChild(button);
                });
            }

            currentGameState = stateKey; // Update de huidige staat
        }

        // Functie om de speeltijd te formatteren
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}m ${seconds}s`;
        }

        // Functie om high scores op te slaan
        async function saveHighScore(name, score, duration) {
            if (!isFirebaseReady) {
                console.error("Firebase is niet klaar om scores op te slaan.");
                return;
            }
            try {
                const scoresCollectionRef = collection(db, `artifacts/${appId}/public/data/rpg_highscores`);
                await addDoc(scoresCollectionRef, {
                    name: name,
                    score: score,
                    duration: duration, // Sla duur op
                    timestamp: Date.now(),
                    userId: userId
                });
                console.log("Score opgeslagen!");
            } catch (e) {
                console.error("Fout bij het opslaan van score: ", e);
            }
        }

        // Functie om high scores te laden en weer te geven
        async function loadHighScores() {
            if (!isFirebaseReady) {
                console.error("Firebase is niet klaar om scores te laden.");
                highScoreList.innerHTML = '<li>Kan high scores niet laden.</li>';
                return;
            }
            try {
                const scoresCollectionRef = collection(db, `artifacts/${appId}/public/data/rpg_highscores`);
                onSnapshot(scoresCollectionRef, (snapshot) => {
                    const scores = [];
                    snapshot.forEach((doc) => {
                        scores.push(doc.data());
                    });

                    // Sorteer scores: eerst op score (hoogste), dan op duur (laagste)
                    scores.sort((a, b) => {
                        if (b.score !== a.score) {
                            return b.score - a.score; // Hogere score eerst
                        }
                        return a.duration - b.duration; // Snellere tijd eerst bij gelijke score
                    });

                    highScoreList.innerHTML = '';
                    if (scores.length === 0) {
                        highScoreList.innerHTML = '<li>Nog geen high scores!</li>';
                    } else {
                        scores.slice(0, 10).forEach((s, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span>${index + 1}. ${s.name || 'Anoniem'}</span> <span class="score-details"><span>Score: ${s.score}</span> <span>Tijd: ${formatTime(s.duration)}</span></span>`;
                            highScoreList.appendChild(li);
                        });
                    }
                }, (error) => {
                    console.error("Fout bij het luisteren naar high scores:", error);
                    highScoreList.innerHTML = '<li>Fout bij het laden van high scores.</li>';
                });

            } catch (e) {
                console.error("Fout bij het laden van high scores: ", e);
                highScoreList.innerHTML = '<li>Fout bij het laden van high scores.</li>';
            }
        }

        // Start Game - Nu leidt dit naar de karakterselectie
        startGameButton.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            characterSelectionRpgScreen.classList.remove('hidden');
            renderCharacterCards(); // Render de kaarten
        });

        // Select Character Button
        selectCharacterRpgButton.addEventListener('click', () => {
            if (selectedCharacterName) {
                player.name = selectedCharacterName;
                player.chosenNpcRole = selectedCharacterName; // Sla de gekozen NPC rol op

                // Verwijder de gekozen NPC uit de 'friendsMet' lijst als die er al in zou staan
                // Dit zorgt ervoor dat de speler zichzelf niet ontmoet
                player.friendsMet = player.friendsMet.filter(friend => friend !== selectedCharacterName);

                characterSelectionRpgScreen.classList.add('hidden');
                // Reset speler stats voor een nieuw spel
                player.health = 100;
                player.gold = 0;
                player.crystalShards = 0;
                player.reputation = 0;
                player.inventory = [];
                player.friendsMet = []; // Zorg ervoor dat deze leeg is bij start
                player.startTime = Date.now(); // Start de timer
                player.endTime = 0;
                player.duration = 0;

                updateGame('intro'); // Start het spel
            } else {
                console.log("Kies alstublieft een personage om te beginnen!");
            }
        });


        // Overige Event Listeners
        showHighscoresButton.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            highScoreScreen.classList.remove('hidden');
            loadHighScores(); // Laad scores wanneer het scherm wordt geopend
        });
        restartGameButton.addEventListener('click', () => {
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden'); // Terug naar startscherm
            selectedCharacterName = null; // Reset selectie
            selectCharacterRpgButton.disabled = true; // Disable knop
        });
        backToMenuFromHighscoresButton.addEventListener('click', () => {
            highScoreScreen.classList.add('hidden');
            startScreen.classList.remove('hidden'); // Terug naar startscherm
        });

    </script>
</body>
</html>
